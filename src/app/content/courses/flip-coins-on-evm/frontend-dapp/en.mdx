## How to build a Front-End Application with React and ethers.js

Now that we've deployed our smart contract and can easily query data from our subgraph on The Graph, it's time to build a user-friendly front-end application. We'll use [React.js](https://react.dev/) for the UI and [ethers.js](https://docs.ethers.org/v6/) to interact with the blockchain.

In this section, we'll cover:

- Setting up a React application
- Connecting to the blockchain (Base Sepolia in our case) using MetaMask
- Interacting with the smart contract using ethers.js to start a coin flip
- Displaying active coin flips with our subgraph and allowing users to participate

#### Prerequisites

- **Node.js and npm** installed on your machine
- Basic understanding of React.js
- Familiarity with JavaScript and [basic programming concepts](https://levelup.gitconnected.com/a-brief-introduction-to-programming-and-computer-science-d0195195c2d5)

### Setting Up the React Application

#### 1\. Initialize a New React Project

Use `create-react-app` on the command line to bootstrap your project:

```
npx create-react-app ether-coin-flip
```

This should create a fresh React project in your IDE:

![](/courses/flip-coins-on-evm/images/Screenshot_2024-11-27_at_4.42.53_PM.png)

Navigate into the project directory:

```
cd ether-coin-flip
```

#### 2\. Install Required Dependencies

We'll need several packages to interact with the blockchain and handle data fetching:

```
npm install ethers graphql graphql-request @tanstack/react-query
```

- **ethers**: Library for interacting with the Ethereum blockchain.
- **graphql** and **graphql-request**: For querying The Graph's API.
- **@tanstack/react-query**: For managing server state in React applications.

---

Most of the app will be built inside the `App.js` file with additional functionality added in with a `Dashboard.js` component later.

First, we'll take a look at the `App.js` file and explore each section of the code.

---

### Building a React app using Ethers

```javascript
import React, { useState } from "react";
import "./App.css";
import ABI from "./components/ABI.json";
import { ethers } from "ethers";
import Dashboard from "./components/Dashboard.js";
```

- **Imports**:

  - **React**: Core library for building UI components.
  - **useState**: React Hook for [managing state](https://react.dev/learn/managing-state).
  - **ABI.json**: The contract's ABI (Application Binary Interface) necessary for interacting with the smart contract.
  - **ethers**: Library for blockchain interactions.
  - **Dashboard**: Custom component we'll use to display active coin flips.

---

```javascript
const contractAddress = "0xd3037A0CFfADA943253A0CCc84593cd7b79E1ABd";
const abi = ABI;
```

- **contractAddress**: The address where your `EtherCoinFlip` contract is deployed on Base Sepolia.
- **abi**: The ABI of your contract imported from `ABI.json`.

---

```javascript
// Using Base Sepolia
const baseSepoliaChainId \= "84532";

const baseSepoliaParams \= {
  chainId: baseSepoliaChainId,
  chainName: "Base Sepolia",
  nativeCurrency: {
      name: "Sepolia ETH",
      symbol: "ETH",
      decimals: 18,
  },
  rpcUrls: \["https://sepolia.base.org"\],
  blockExplorerUrls: \["https://base-sepolia.blockscout.com/"\],
};
```

- **baseSepoliaChainId**: The chain ID for the Base Sepolia network.
- **baseSepoliaParams**: Network parameters required to add or switch to Base Sepolia in MetaMask.

---

```javascript
let provider, signer;
```

- **provider**: An ethers.js provider to interact with the blockchain.
- **signer**: An ethers.js signer representing the user's wallet.

---

#### Function: `switchToBaseSepolia`

```javascript
async function switchToBaseSepolia() {
  try {
    const currentChainId = await provider.send("eth_chainId", []);

    if (currentChainId !== baseSepoliaChainId) {
      try {
        await provider.send("wallet_switchEthereumChain", [
          { chainId: baseSepoliaChainId },
        ]);
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await provider.send("wallet_addEthereumChain", [baseSepoliaParams]);
          } catch (addError) {
            console.error("Failed to add Base Sepolia network:", addError);
          }
        } else {
          console.error("Failed to switch to Base Sepolia:", switchError);
        }
      }
    }
  } catch (error) {
    console.error("Failed to get chain ID or switch network:", error);
  }
}
```

- **Purpose**: Ensures the user's MetaMask is connected to the Base Sepolia network.
- **Steps**:

  1.  **Get Current Chain ID**: Fetches the chain ID of the currently connected network.
  2.  **Check if Already Connected**: Compares it with `baseSepoliaChainId`.
  3.  **Switch Network**: If not connected, attempts to switch to Base Sepolia.

      - **Switch Chain**: Uses `wallet_switchEthereumChain`.
      - **Add Network**: If the network is not added (`error code 4902`), it adds the network using `wallet_addEthereumChain`.

  4.  **Error Handling**: Logs errors if switching or adding the network fails.

---

#### Component: `App`

```javascript
function App() {
  const [isConnected, setIsConnected] = useState(false);
  const [contractInstance, setContractInstance] = useState(null);
```

- **State Variables**:

  - **isConnected**: Tracks if the user's wallet is connected.
  - **contractInstance**: Stores the initialized contract instance for interaction.

---

#### Function: `connectWallet`

```javascript
const connectWallet = async () => {
  try {
    await initializeProvider();

    setIsConnected(true);
  } catch (error) {
    console.error("Error connecting wallet:", error);
  }
};
```

- **Purpose**: Initiates wallet connection and provider setup.
- **Steps**:

  1.  **Initialize Provider**: Calls `initializeProvider`.
  2.  **Update State**: Sets `isConnected` to `true` upon success.
  3.  **Error Handling**: Logs any errors during the connection process.

---

#### Function: `initializeProvider`

```javascript
async function initializeProvider() {
  if (typeof window.ethereum !== "undefined") {
    try {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      const contract = new ethers.Contract(contractAddress, abi, signer);
      await switchToBaseSepolia();
      setContractInstance(contract); // Store contract in state
    } catch (error) {
      console.error("Error initializing provider:", error);
    }
  } else {
    alert(
      "No Ethereum provider detected. Please install MetaMask or another Ethereum wallet."
    );
  }
}
```

- **Purpose**: Sets up the ethers.js provider and signer, connects to the smart contract.
- **Steps**:

  1.  **Check MetaMask Installation**: Verifies if `window.ethereum` is available.
  2.  **Create Provider**: Initializes a new `Web3Provider` using MetaMask's provider.
  3.  **Request Accounts**: Prompts the user to connect their wallet.
  4.  **Get Signer**: Retrieves the signer representing the user's account.
  5.  **Initialize Contract**: Creates a new contract instance with the ABI and signer.
  6.  **Switch Network**: Calls `switchToBaseSepolia` to ensure the correct network is selected.
  7.  **Store Contract**: Updates `contractInstance` in the state for later use.
  8.  **Error Handling**: Alerts the user if MetaMask is not installed.

---

#### Component: `StartCoinFlipButton`

```javascript
function StartCoinFlipButton({ contract }) {
  const [wager, setWager] = useState("");
```

- **Purpose**: Provides an interface for users to start a new coin flip by entering a wager amount.
- **Props**:

  - **contract**: The initialized contract instance passed from the `App` component.

- **State**:

  - **wager**: The amount of Ether the user wants to wager.

```javascript
const startCoinFlip = async () => {
  if (!contract) {
    console.error("Contract is not initialized");
    return;
  }

  console.log(`Starting Coin Flip`);
  console.log(`Wager Amount: ${wager} ETH`);

  try {
    const transaction = await contract.newCoinFlip({
      value: ethers.utils.parseEther(wager),
    });
    await transaction.wait();
    console.log(`Coin flip started with a wager of ${wager} ETH!`);
  } catch (error) {
    console.error("Error starting coin flip:", error);
  }
};
```

- **Purpose**: Calls the `newCoinFlip` function on the smart contract with the specified wager.
- **Steps**:

  1.  **Check Contract Initialization**: Ensures the contract is available.
  2.  **Log Action**: Outputs debug information to the console.
  3.  **Execute Transaction**: Calls `newCoinFlip` with the wager converted to Wei.
  4.  **Wait for Confirmation**: Waits for the transaction to be mined.
  5.  **Error Handling**: Logs any errors during the transaction.

#### Render Function for `StartCoinFlipButton`

```javascript
return (
  <div>
    <input
      type="number"
      placeholder="Enter Wager Amount in ETH"
      value={wager}
      onChange={(e) => setWager(e.target.value)}
    />
    <button onClick={startCoinFlip}>Start Coin Flip</button>
  </div>
);
```

- **Components**:

  - **Input Field**: Allows the user to enter the wager amount in Ether.

    - `value`: Bound to the `wager` state variable.
    - `onChange`: Updates the `wager` state when the input changes.

  - **Button**: Triggers the `startCoinFlip` function when clicked.

---

#### Render Function of `App`

```javascript
return (
  <div className="App">
    <h1>Ether Coin Flip</h1>
    {!isConnected ? (
      <button onClick={connectWallet}>Connect Wallet</button>
    ) : (
      <>
        <StartCoinFlipButton contract={contractInstance} />
        <Dashboard contract={contractInstance} />
      </>
    )}
  </div>
);
```

- **Components**:

  - **Header**: Displays the title of the application.
  - **Conditional Rendering**:

    - **Not Connected**: Shows a **"Connect Wallet"** button if the user is not connected.
    - **Connected**: Renders the `StartCoinFlipButton` and `Dashboard` components when the wallet is connected.

And that is everything inside the `App.js` file! Here is all of it together:

```javascript
import React, { useState } from "react";
import "./App.css";
import ABI from "./components/ABI.json";
import { ethers } from "ethers";
import Dashboard from "./components/Dashboard.js";

const contractAddress = "0xd3037A0CFfADA943253A0CCc84593cd7b79E1ABd";
const abi = ABI;

// Using Base Sepolia
const baseSepoliaChainId = "84532";

const baseSepoliaParams = {
  chainId: baseSepoliaChainId,
  chainName: "Base Sepolia",
  nativeCurrency: {
    name: "Sepolia ETH",
    symbol: "ETH",
    decimals: 18,
  },
  rpcUrls: ["https://sepolia.base.org"],
  blockExplorerUrls: ["https://base-sepolia.blockscout.com/"],
};

let provider, signer;

async function switchToBaseSepolia() {
  try {
    const currentChainId = await provider.send("eth_chainId", []);

    if (currentChainId !== baseSepoliaChainId) {
      try {
        await provider.send("wallet_switchEthereumChain", [
          { chainId: baseSepoliaChainId },
        ]);
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await provider.send("wallet_addEthereumChain", [baseSepoliaParams]);
          } catch (addError) {
            console.error("Failed to add Base Sepolia network:", addError);
          }
        } else {
          console.error("Failed to switch to Base Sepolia:", switchError);
        }
      }
    }
  } catch (error) {
    console.error("Failed to get chain ID or switch network:", error);
  }
}

function App() {
  const [isConnected, setIsConnected] = useState(false);
  const [contractInstance, setContractInstance] = useState(null);

  const connectWallet = async () => {
    try {
      await initializeProvider();
      setIsConnected(true);
    } catch (error) {
      console.error("Error connecting wallet:", error);
    }
  };

  async function initializeProvider() {
    if (typeof window.ethereum !== "undefined") {
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const contract = new ethers.Contract(contractAddress, abi, signer);
        await switchToBaseSepolia();
        setContractInstance(contract); // Store contract in state
      } catch (error) {
        console.error("Error initializing provider:", error);
      }
    } else {
      alert("MetaMask is not installed. Please install MetaMask.");
    }
  }

  function StartCoinFlipButton({ contract }) {
    const [wager, setWager] = useState("");

    const startCoinFlip = async () => {
      if (!contract) {
        console.error("Contract is not initialized");
        return;
      }

      console.log(`Starting Coin Flip`);
      console.log(`Wager Amount: ${wager} ETH`);

      try {
        const transaction = await contract.newCoinFlip({
          value: ethers.utils.parseEther(wager),
        });
        await transaction.wait();
        console.log(`Coin flip started with a wager of ${wager} ETH!`);
      } catch (error) {
        console.error("Error starting coin flip:", error);
      }
    };

    return (
      <div>
        <input
          type="number"
          placeholder="Enter Wager Amount in ETH"
          value={wager}
          onChange={(e) => setWager(e.target.value)}
        />
        <button onClick={startCoinFlip}>Start Coin Flip</button>
      </div>
    );
  }

  return (
    <div className="App">
      <h1>Ether Coin Flip</h1>
      {!isConnected ? (
        <button onClick={connectWallet}>Connect Wallet</button>
      ) : (
        <>
          <StartCoinFlipButton contract={contractInstance} />
          <Dashboard contract={contractInstance} />
        </>
      )}
    </div>
  );
}

export default App;
```

---

Now that we have finished the `App.js` file, it is time to create the Dashboard component for displaying active coin flips. This page should contain:

- The ability to start coin flips
- A dashboard displaying active coin flips (using our subgraph on The Graph)
- A button to end any given coin flip

It will also display a button for users to “end” a coin flip, with the ether amount & coin flip ID automatically used inside the function call, making the game simple and accessible.

### **Designing a Dashboard in React**

```javascript
import React from "react";
import { useQuery } from "@tanstack/react-query";
import { gql, request } from "graphql-request";
import { ethers } from "ethers";
```

- **Imports**:

  - **React**: Core library for building UI components.
  - **useQuery**: Hook from `@tanstack/react-query` for data fetching.
  - **gql**, **request**: Functions from `graphql-request` for making GraphQL queries.
  - **ethers**: Library for blockchain interactions.

---

#### GraphQL Query

```javascript
const query = gql`
  {
    startedCoinFlips(first: 10) {
      id
      theCoinFlipID
      theBetStarter
      theStartingWager
      blockNumber
      blockTimestamp
      isActive
      transactionHash
    }
    finishedCoinFlips(first: 10) {
      id
      theCoinFlipID
      winner
      loser
      blockNumber
      blockTimestamp
    }
  }
`;
```

- **Purpose**: Defines a GraphQL query to fetch the latest 10 started and finished coin flips from The Graph.
- **Entities Queried**:

  - **startedCoinFlips**: Active coin flips that have been initiated.
  - **finishedCoinFlips**: Coin flips that have been completed.

---

#### GraphQL API URL

```javascript
const url = process.env.REACT_APP_THE_GRAPH_API_URL;
```

- **Purpose**: Retrieves the subgraph API URL from environment variables.

---

#### Component: `Dashboard`

```javascript
export default function Dashboard({ contract }) {
  const { data, status } = useQuery({
    queryKey: ["activeCoinFlips"],
    async queryFn() {
      return await request(url, query);
    },
});
```

- **Props**:

  - **contract**: The initialized contract instance passed from the `App` component.

- **useQuery Hook**:

  - **queryKey**: Identifies the query for caching purposes.
  - **queryFn**: Async function that executes the GraphQL query.

- **Returned Values**:

  - **data**: The data fetched from the API.
  - **status**: The status of the query (`loading`, `error`, `success`).

---

#### Function: `endCoinFlip`

```javascript
const endCoinFlip = async (coinFlipID, startingWager) => {
  if (!contract) {
    console.error("Contract is not initialized");
    return;
  }

  try {
    // Parse coinFlipID to integer
    const coinFlipIDInt = parseInt(coinFlipID);
    // Ensure startingWager is a string representing the amount in wei
    const wagerValue = ethers.BigNumber.from(startingWager.toString());

    alert(
      `Ending Coin Flip ID: ${coinFlipIDInt} with Wager: ${ethers.utils.formatEther(
        wagerValue
      )} ETH`
    );

    const transaction = await contract.endCoinFlip(coinFlipIDInt, {
      value: wagerValue,
    });
    await transaction.wait();

    console.log(
      `Coin flip with ID ${coinFlipIDInt} ended with a wager of ${ethers.utils.formatEther(
        wagerValue
      )} ETH!`
    );

    // Retrieve the details of the coin flip from the contract to check the winner/loser

    const coinFlipDetails = await contract.EtherCoinFlipStructs(coinFlipIDInt);
    const currentAddress = await contract.signer.getAddress();

    if (coinFlipDetails.winner.toLowerCase() === currentAddress.toLowerCase()) {
      alert("Congratulations! You won the coin flip!");
    } else {
      alert("Sorry, you lost the coin flip.");
    }
  } catch (error) {
    console.error("Error ending coin flip:", error);
    alert("Error ending coin flip. Please check the console for details.");
  }
};
```

- **Purpose**: Allows the user to join an active coin flip by calling `endCoinFlip` on the smart contract.
- **Steps**:

  1.  **Check Contract Initialization**: Ensures the contract is available.
  2.  **Parse Inputs**:

      - **coinFlipIDInt**: Converts the `coinFlipID` to an integer.
      - **wagerValue**: Converts the `startingWager` to a BigNumber in Wei.

  3.  **Alert User**: Notifies the user about the action being taken.
  4.  **Execute Transaction**: Calls `endCoinFlip` with the appropriate parameters.
  5.  **Wait for Confirmation**: Waits for the transaction to be mined.
  6.  **Retrieve Coin Flip Details**: Fetches the updated coin flip data from the contract.
  7.  **Determine Outcome**: Checks if the current user is the winner or loser.
  8.  **Alert User of Outcome**: Displays a message indicating whether the user won or lost.
  9.  **Error Handling**: Logs any errors and alerts the user.

---

#### Function: `getActiveCoinFlips`

```javascript
// Function to filter active coin flips
const getActiveCoinFlips = () => {
  if (!data) return [];

  const startedFlips = data.startedCoinFlips || [];
  const finishedFlips = data.finishedCoinFlips || [];

  const finishedIDs = new Set(finishedFlips.map((flip) => flip.theCoinFlipID));

  // Filter out finished coin flips

  return startedFlips.filter((flip) => !finishedIDs.has(flip.theCoinFlipID));
};

const activeCoinFlips = getActiveCoinFlips();
```

- **Purpose**: Processes the fetched data to obtain a list of active coin flips.
- **Steps**:

  1.  **Check Data Availability**: Returns an empty array if data is not available.
  2.  **Extract Started and Finished Flips**: Gets arrays of started and finished coin flips.
  3.  **Create Set of Finished IDs**: Uses a `Set` for efficient lookup of finished coin flip IDs.
  4.  **Filter Active Flips**: Removes any started coin flips that have been finished.
  5.  **Result**: Returns an array of active coin flips.

---

#### Render Function

```javascript
return (
  <main>
    {status === "loading" && <div>Loading active coin flips...</div>}
    {status === "error" && <div>Error occurred querying the subgraph :</div>}
    {status === "success" && activeCoinFlips.length > 0 ? (
      <table>
        <thead>
          <tr>
            <th>Coin Flip ID</th>
            <th>Bet Starter</th>
            <th>Wager</th>
            <th>Action</th>
            <th>Transaction</th>
          </tr>
        </thead>
        <tbody>
          {activeCoinFlips.map((flip) => (
            <tr key={flip.id}>
              <td>{flip.theCoinFlipID}</td>
              <td>{flip.theBetStarter}</td>
              <td>{ethers.utils.formatEther(flip.theStartingWager)} ETH</td>
              <td>
                <button
                  onClick={() =>
                    endCoinFlip(flip.theCoinFlipID, flip.theStartingWager)
                  }
                >
                  End Coin Flip
                </button>
              </td>
              <td>
                <a
                  href={`https://base-sepolia.blockscout.com/tx/${flip.transactionHash}`}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  View on Block Explorer
                </a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    ) : (
      <p>No active coin flips available D:</p>
    )}
  </main>
);
```

- **Conditional Rendering**:

  - **Loading State**: Displays a loading message while the data is being fetched.
  - **Error State**: Shows an error message if the query fails.
  - **Success State**:

    - **Active Coin Flips Available**: Renders a table listing all active coin flips.
    - **No Active Coin Flips**: Displays a message indicating that there are no active coin flips.

- **Table Structure**:

  - **Headers**: Defines the columns for coin flip details.
  - **Rows**: Iterates over `activeCoinFlips` to display each coin flip.

    - **Coin Flip ID**: The unique identifier of the coin flip.
    - **Bet Starter**: Address of the player who started the coin flip.
    - **Wager**: The wager amount formatted in Ether.
    - **Action**: A button to end the coin flip, calling `endCoinFlip`.
    - **Transaction**: A link to view the transaction on the Block Explorer.

---

#### Running the React Application

In order to run the website locally, complete the following steps:

1.  Start the development server

```
npm start
```

1.  In your browser, open http://localhost:3000
2.  Connect your wallet
3.  Start a new coin flip by entering the wager amount & clicking the start coin flip button
4.  End a coin flip by selecting one from the dashboard and clicking the end coin flip button

---

Now, your should have the site running locally and connected to Base Sepolia via ethers.js!

![](/courses/flip-coins-on-evm/images/Screenshot_2024-11-27_at_4.51.28_PM.png)
